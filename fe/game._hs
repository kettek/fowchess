eventsource GameUpdates
  on message as json
    log it
  end

  on open
    log "opened stream"
  end

  on exit
    log "got exit"
    GameUpdates.close()
  end
end

behavior Game()
  init
    game.auth()
  end
  on mutation of @game_id
    GameUpdates.open('http://localhost:4000/stream')
    -- TODO: Issue fetch for game?
    log "TODO: Some sort of game API fetch"
  end
end

def game.showCreateDialog()
  if no #CreateDialog then
    make <div#CreateDialog/>
    set its @script to 'install CreateDialog'
    put it at the end of document.body
    log "do soemthintg"
  end
end

def game.auth
  show #AuthDialog
  log "auth"
  set myId to localStorage.getItem('id')
  log myId
  if no myId then
    fetch /auth as json with headers: {'Content-Type': 'application/json'}, method:"POST"
    log it
    localStorage.setItem('id', it.id)
  else
    fetch /auth as json with headers: {'Content-Type': 'application/json'}, method:"POST", body: JSON.stringify({id: myId})
    log it
  end
  hide #AuthDialog
end

def game.create(obj)
  fetch /game/create as json with headers: {'Content-Type': 'application/json'}, method:"POST", body: JSON.stringify(obj)
  if its ok then
    game.join(its id)
  end
  log it
  -- set #game's @game_id to "some game"
end

def game.join(id)
  fetch `/games/${id}`
  log it
  -- TODO
  log "join " + id
end

def game.leave()
  -- TODO
  log "leave"
end